# Serious bugs identified

This report lists twenty serious defects discovered in the repository.

1. **`Tremove` unlinks from the filesystem root with a NULL name.** The `rremove` handler hardcodes `EXT2_ROOT_INO` and passes a null filename to `ext2fs_unlink`, so it never removes the intended directory entry and fails for anything outside the root directory.【F:userspace/servers/ext4fs/ext4fs.c†L600-L604】
2. **Directory reads treat the 9P offset as an entry index instead of the byte cookie.** `dirread_callback` only skips a fixed number of entries and ignores the caller-supplied offset, causing clients to see duplicate or skipped directory entries and preventing correct `seek` behaviour.【F:userspace/servers/ext4fs/ext4fs.c†L260-L314】
3. **9P message sizes are decoded through signed `char` values.** `msgbuf` is a `char` array, so reconstructing the little-endian length by shifting `msgbuf[i]` sign-extends bytes ≥0x80, corrupting the computed size for large messages.【F:userspace/servers/ext4fs/ext4fs.c†L28-L31】【F:userspace/servers/ext4fs/ext4fs.c†L634-L640】
4. **The server assumes `read(2)` returns an entire 9P message in one call.** Both the header and payload reads break the connection whenever the kernel delivers a short read, which is legal on pipes and sockets.【F:userspace/servers/ext4fs/ext4fs.c†L630-L640】
5. **Replies are written with a single unchecked `write(2)`.** Any short write silently truncates the reply, corrupting the protocol stream.【F:userspace/servers/ext4fs/ext4fs.c†L665-L667】
6. **Open mode tracking rejects writable fids that include auxiliary flags.** The server stores the raw open mode and later compares it to `OWRITE`/`ORDWR`, so clients that requested `ORDWR|OTRUNC` or `OWRITE|ORCLOSE` are incorrectly denied writes.【F:userspace/servers/ext4fs/ext4fs.c†L240-L257】【F:userspace/servers/ext4fs/ext4fs.c†L409-L417】
7. **`rattach` ignores failures when reading the root inode.** If `ext2fs_read_inode` fails the code still fabricates a `qid` from uninitialised memory, returning garbage to the client instead of an error.【F:userspace/servers/ext4fs/ext4fs.c†L165-L176】
8. **Inode numbers are formatted with `%u`.** `ext2_ino_t` is 64-bit on ext4, so `snprintf(namebuf, "%u", ino)` truncates high bits and can generate duplicate stat names.【F:userspace/servers/ext4fs/ext4fs.c†L132-L136】
9. **Directory creation removes the link it just created.** After calling `ext2fs_mkdir`, `rcreate` unconditionally unlinks `tx->tcreate.name`, leaving the new directory unreachable from its parent.【F:userspace/servers/ext4fs/ext4fs.c†L552-L568】
10. **`rcreate` leaks reserved inodes on error paths.** When `ext2fs_write_new_inode` or `ext2fs_link` fails, the freshly allocated inode is left in use because the code never calls `ext2fs_inode_alloc_stats2(..., -1, ...)` to free it.【F:userspace/servers/ext4fs/ext4fs.c†L525-L556】
11. **Twrite parsing trusts unvalidated lengths.** `readMsg` slices `data[16:16+fc.Count]` without checking the buffer length, so a malicious client can panic the server via an oversized count.【F:userspace/go-servers/p9/server.go†L140-L145】
12. **Tcreate parsing blindly indexes the residual buffer.** After reading the file name, the code reads `r.data[0:4]` and `r.data[4]` without confirming at least five bytes remain, leading to panics on malformed frames.【F:userspace/go-servers/p9/server.go†L129-L134】
13. **Responses are emitted with a single unchecked `Write`.** `writeMsg` never retries partial writes, so a short write corrupts the 9P stream.【F:userspace/go-servers/p9/server.go†L200-L205】
14. **Tflush is unsupported.** The dispatcher lacks a `case Tflush:` branch, so clients attempting to cancel in-flight operations receive `Rerror` rather than the mandated `Rflush`.【F:userspace/go-servers/p9/server.go†L208-L295】
15. **Twstat is also unimplemented.** The dispatcher drops Twstat requests through the default case, preventing metadata updates and violating the protocol.【F:userspace/go-servers/p9/server.go†L208-L295】
16. **`writeString` truncates names silently.** Casting `len(s)` to `uint16` without validation causes strings ≥65 536 bytes to wrap and desynchronise the stream instead of returning an error.【F:userspace/go-servers/p9/protocol.go†L149-L155】
17. **MemFS `Walk` ignores the requested path elements.** It always returns the current fid’s `qid` regardless of `names`, so clients can never traverse the tree.【F:userspace/go-servers/memfs/memfs.go†L45-L57】
18. **MemFS `Read` disregards offsets.** The handler always returns the greeting string, so clients reading past the first chunk loop forever because they never see EOF.【F:userspace/go-servers/memfs/memfs.go†L75-L77】
19. **The borrow checker’s hash table has the wrong element type.** `BorrowPool` declares `owners` as `struct BorrowOwner*`, but the implementation treats it as an array of `BorrowBucket` structs with `head` pointers, leading to out-of-bounds writes and crashes once the table is used.【F:kernel/include/borrowchecker.h†L38-L44】【F:kernel/borrowchecker.c†L16-L36】
20. **Shared borrows are not tracked per borrower.** `borrow_borrow_shared` only increments a counter, and `borrow_return_shared` never consults the `borrower` argument, so any process can drop another task’s borrow and violate Rust-style exclusivity guarantees.【F:kernel/borrowchecker.c†L201-L302】
21. **`init` calls `exec` with a null argv vector.** Both fallbacks invoke `exec("/sbin/init", NULL)` and `exec("/bin/sh", NULL)`, dereferencing a null pointer inside the syscall shim instead of passing a valid argument array, so even a working `exec` implementation would fail immediately.【F:userspace/bin/init.c†L149-L156】
22. **All of `init`’s process management stubs return failure.** The placeholder `fork()` always returns `-1`, preventing the filesystem server from ever starting.【F:userspace/bin/syscalls.c†L7-L11】
23. **`exec` is hardwired to fail.** The stubbed implementation just returns `-1`, so even if `fork` succeeded no program can ever be executed.【F:userspace/bin/syscalls.c†L13-L20】
24. **Mounting the root filesystem is impossible.** The `mount` stub ignores its arguments and returns `-1`, forcing `init` into the emergency shell path on every boot.【F:userspace/bin/syscalls.c†L22-L30】
25. **Basic file I/O stubs also fail unconditionally.** `open` always returns `-1`, so even after a successful mount `init` reports that `/etc/fstab` is missing.【F:userspace/bin/syscalls.c†L32-L39】
26. **`exit` spins forever.** The stub just loops, so any userspace task that tries to exit will hang instead of terminating.【F:userspace/bin/syscalls.c†L41-L47】
27. **`printf` ignores every format specifier.** The stub drops `%s` and `%d` without consuming arguments, so none of the diagnostic output in `init` (or other programs) actually reports runtime state.【F:userspace/bin/syscalls.c†L90-L107】
28. **`BorrowOwner` lacks the list linkage the implementation assumes.** The header omits a `next` pointer, yet the C file treats each bucket as a linked list, corrupting the allocator the first time a second owner is inserted.【F:kernel/include/borrowchecker.h†L17-L35】【F:kernel/borrowchecker.c†L67-L90】
29. **Ownership statistics underflow on every release.** `borrow_release` decrements `borrowpool.nowners`, but reacquiring a freed entry never increments it again, so the counter eventually wraps negative.【F:kernel/borrowchecker.c†L88-L154】
30. **Borrow-aware locks start life with garbage lock state.** `borrow_lock_init` only records the key and never zeroes the embedded `Lock`, so freshly allocated `BorrowLock`s can arrive with the spin bit already set and deadlock their first caller.【F:kernel/include/lock_borrow.h†L12-L18】【F:kernel/9front-port/lock_borrow.c†L46-L52】
31. **`borrow_lock` ignores failures from the borrow checker.** It calls `borrow_acquire` and discards the result, so `borrow_acquire` returning `BORROW_EALREADY` leaves the kernel believing the resource is still owned by the previous holder even though the mutex was taken.【F:kernel/9front-port/lock_borrow.c†L55-L75】【F:kernel/borrowchecker.c†L93-L122】
32. **`borrow_unlock` drops the mutex even when release fails.** If `borrow_release` reports outstanding borrows, the wrapper ignores the error and still calls `unlock`, violating the exclusivity contract it is meant to enforce.【F:kernel/9front-port/lock_borrow.c†L77-L84】【F:kernel/borrowchecker.c†L124-L156】
33. **Page ownership tracking is permanently disabled.** `pageowninit` sets `pageownpool.pages = nil` and never allocates descriptors later, so every `pa2owner` lookup returns `nil` and all ownership/borrow APIs bail out with `POWN_EINVAL`.【F:kernel/9front-port/pageown.c†L32-L70】
34. **Any process can drop another task’s shared page borrow.** `pageown_return_shared` only checks that `shared_count > 0`, ignoring the `borrower` argument entirely, so hostile processes can revoke someone else’s read mapping.【F:kernel/9front-port/pageown.c†L278-L307】
35. **Killing a borrower leaks the shared-borrow counter.** `pageown_cleanup_process` zeroes `shared_count` when tearing down an owner but never decrements `pageownpool.nshared`, so the aggregate statistics drift upward forever.【F:kernel/9front-port/pageown.c†L438-L456】
36. **The random number generator scribbles over its own lock.** `randomseed` passes the enclosing struct to `setupChachastate` instead of the embedded `Chachastate`, overwriting the `QLock` fields and making future `randomread` calls race or crash.【F:kernel/9front-port/random.c†L71-L108】
37. **`fscheck` treats fatal superblock errors as success.** If `check_superblock` returns `-1`, the accumulator stays negative, causing the tool to print “Filesystem is clean” and exit 0 even though the superblock was unreadable.【F:userspace/bin/fscheck.c†L152-L167】【F:userspace/bin/fscheck.c†L245-L268】
38. **Zero-length reads are reported as out-of-memory.** Both directory and file reads call `malloc(tx->tread.count)` and treat a `NULL` return as fatal, so a legitimate `count == 0` request yields `Rerror` instead of an empty reply.【F:userspace/servers/ext4fs/ext4fs.c†L341-L399】
39. **`ropen` trusts `ext2fs_read_inode` without checking errors.** If libext2fs fails, the server still fabricates a `qid` from uninitialised stack data and returns success to the client.【F:userspace/servers/ext4fs/ext4fs.c†L240-L257】
40. **`fscheck`’s block bitmap pass is a complete no-op.** The loop over every block never inspects or records inconsistencies, so the utility cannot catch any allocation bitmap corruption.【F:userspace/bin/fscheck.c†L47-L73】
41. **Borrow counters only ever increase.** Both shared and mutable borrow paths increment `borrow_count`, but `pageown_return_shared` and `pageown_return_mut` never decrement it, so page descriptors rapidly overflow their statistics and suggest live borrows that no longer exist.【F:kernel/9front-port/pageown.c†L208-L310】
42. **`fscheck` treats fatal errors as success.** The checker accumulates return values directly, so any routine that reports `-1` leaves the total negative; the final `errors > 0` gate then misreports the run as clean and returns 0 even when every pass failed.【F:userspace/bin/fscheck.c†L158-L267】
43. **Serial console output is silently discarded.** The platform `uartputs` routine is a stub that ignores its arguments, so nothing ever reaches the UART or buffered console queues.【F:kernel/9front-pc64/globals.c†L123-L130】
44. **Kernel timekeeping never advances.** `fastticks` always returns 0, so the TOD code sees no delta between successive calls and the system clock, scheduler statistics, and timeout logic all freeze.【F:kernel/9front-pc64/globals.c†L129-L142】 *(Fixed: `kernel/9front-port/fastticks.c` now calls the 9front `arch->fastclock` hook, so fastticks returns real hardware ticks.)*
45. **Microsecond timestamps are permanently zero.** The µs helper just returns 0, breaking any code that relies on monotonic microsecond measurements or timeout conversions.【F:kernel/9front-pc64/globals.c†L139-L142】 *(Fixed alongside bug #44; `µs()` now converts the genuine fast clock ticks to microseconds.)*
46. **`poolrealloc` copies past the end of allocations.** It blindly `memmove`s `size` bytes from the old pointer without knowing the original allocation size, so growing a buffer reads off the end of the old block and corrupts memory.【F:kernel/9front-pc64/globals.c†L64-L73】 *(Fixed: pool headers now track the requested size, and `poolrealloc` copies only the minimum of old and new lengths.)*
47. **Aligned pool allocations ignore the requested alignment.** `poolallocalign` simply calls `xalloc` and drops the `align` argument, so callers that require cache-line or hardware-mandated alignment end up with misaligned buffers.【F:kernel/9front-pc64/globals.c†L58-L61】 *(Fixed: pool allocations maintain per-block headers and honour alignment, offset, and span constraints.)*
48. **Architecture-specific devices can never be registered.** `addarchfile` immediately returns `nil` without storing the handlers, so attempts such as `iomapinit` to expose `/dev/ioalloc` silently fail.【F:kernel/9front-pc64/globals.c†L152-L156】
49. **Path sanitisation is completely disabled.** `cleanname` just returns its input pointer, leaving `..` and redundant separators intact and letting callers traverse outside of the intended namespace.【F:kernel/9front-pc64/globals.c†L102-L105】
50. **Delay helpers spin for zero time.** Both `microdelay` and `delay` are empty stubs, so drivers that rely on hardware-settling delays or retry backoff race the device immediately and tend to fail.【F:kernel/9front-pc64/globals.c†L124-L131】
51. **The pager is never kicked on low-memory conditions.** `kickpager` is a no-op, so `newpage`’s attempt to wake the pager thread during shortages does nothing and callers loop forever waiting for relief.【F:kernel/9front-pc64/globals.c†L147-L151】【F:kernel/9front-port/page.c†L120-L168】 *(Fixed: `kickpager` now wakes `swapalloc.r` so the pager thread runs as soon as memory pressure is detected.)*
52. **Interrupt controllers are never initialised.** `irqinit` is an empty stub, so the PIC/APIC setup never runs and all external interrupts stay masked.【F:kernel/9front-pc64/globals.c†L360-L367】【F:kernel/9front-pc64/trap.c†L75-L83】
53. **PCI configuration space is unreachable.** `pcicfginit` immediately returns, leaving the PCI bus undiscovered and all PCI devices invisible to the kernel.【F:kernel/9front-pc64/globals.c†L372-L376】【F:kernel/9front-pc64/main.c†L380-L385】
54. **Device reset hooks are replaced with inert stubs.** `chandevreset` calls local no-op helpers for the console, mount, and proc drivers, so none of those subsystems ever register their devices or queues.【F:kernel/9front-port/chan.c†L147-L177】
55. **Formatters are never registered.** `fmtinstall` ignores the request, so modules that expect `%F`, `%D`, or other custom verbs fail to print meaningful diagnostics.【F:kernel/9front-pc64/globals.c†L132-L142】 *(Fixed: 9front’s full `fmt.c`/`fmtlock.c` now live in `kernel/libc9/`, so `fmtinstall` registers handlers properly.)*
56. **`fmtstrinit` leaves `Fmt` structures uninitialised.** It just returns 0, so callers like `syscallfmt` operate on empty buffers and panic once they start formatting.【F:kernel/9front-pc64/globals.c†L493-L496】【F:kernel/9front-port/syscallfmt.c†L69-L145】 *(Fixed: `kernel/libc9/vsmprint.c` provides 9front’s allocator-backed implementation.)*
57. **`fmtprint` drops all formatted output.** The stub returns 0 without touching the target buffer, erasing syscall trace logging and any other formatted strings built via `Fmt`.【F:kernel/9front-pc64/globals.c†L493-L496】【F:kernel/9front-port/syscallfmt.c†L69-L361】 *(Fixed: `kernel/libc9/fmtprint.c` now matches 9front and routes through `dofmt` while preserving the caller’s `va_list`.)*
58. **Replies can exceed the negotiated `msize`.** `writeMsg` never checks whether the encoded response fits within `s.msize`, so large reads or stats generate oversized frames that violate the protocol and desynchronise the client.【F:userspace/go-servers/p9/server.go†L153-L205】
59. **Malformed strings desynchronise the Go 9P parser.** Every `readString` call in `readMsg` ignores its error return, so truncated frames leave partially consumed buffers that throw subsequent field parsing and panics the server.【F:userspace/go-servers/p9/server.go†L103-L133】【F:userspace/go-servers/p9/protocol.go†L137-L152】
60. **Stat marshalling crashes on allocation failure.** `ino2stat` never checks the four `strdup` results; if any return `NULL`, `convD2M` later dereferences them and the server dies instead of reporting `Rerror`.【F:userspace/servers/ext4fs/ext4fs.c†L132-L138】【F:userspace/servers/ext4fs/ext4fs.c†L341-L399】
