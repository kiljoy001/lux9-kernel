/*
 * Simple framebuffer console driver for Limine framebuffer
 */

#include "u.h"
#include <lib.h>
#include "mem.h"
#include "dat.h"
#include "fns.h"
#include "../../limine.h"

extern struct limine_framebuffer_request *limine_framebuffer;

static struct {
	uchar *addr;
	u64int width;
	u64int height;
	u64int pitch;
	u16int bpp;
	int initialized;
	int x, y;  /* Current cursor position in characters */
	u32int fg, bg;  /* Foreground and background colors */
} fb;

/* Simple 8x16 font - just enough to display characters */
#define FONT_WIDTH 8
#define FONT_HEIGHT 16

/* Very simple built-in font for ASCII 32-126 */
static uchar font8x16[95][16] = {
	/* Space (32) */
	{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	/* ! */
	{0x00,0x00,0x18,0x3C,0x3C,0x3C,0x18,0x18,0x18,0x00,0x18,0x18,0x00,0x00,0x00,0x00},
	/* " */
	{0x00,0x63,0x63,0x63,0x22,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	/* # */
	{0x00,0x00,0x00,0x36,0x36,0x7F,0x36,0x36,0x36,0x7F,0x36,0x36,0x00,0x00,0x00,0x00},
	/* $ */
	{0x0C,0x0C,0x3E,0x63,0x61,0x60,0x3E,0x03,0x03,0x43,0x63,0x3E,0x0C,0x0C,0x00,0x00},
	/* % */
	{0x00,0x00,0x00,0x00,0x00,0x61,0x63,0x06,0x0C,0x18,0x33,0x63,0x00,0x00,0x00,0x00},
	/* & */
	{0x00,0x00,0x1C,0x36,0x36,0x1C,0x3B,0x6E,0x66,0x66,0x66,0x3B,0x00,0x00,0x00,0x00},
	/* ' */
	{0x00,0x30,0x30,0x30,0x60,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	/* ( */
	{0x00,0x00,0x0C,0x18,0x18,0x30,0x30,0x30,0x30,0x18,0x18,0x0C,0x00,0x00,0x00,0x00},
	/* ) */
	{0x00,0x00,0x18,0x0C,0x0C,0x06,0x06,0x06,0x06,0x0C,0x0C,0x18,0x00,0x00,0x00,0x00},
	/* * */
	{0x00,0x00,0x00,0x00,0x42,0x66,0x3C,0xFF,0x3C,0x66,0x42,0x00,0x00,0x00,0x00,0x00},
	/* + */
	{0x00,0x00,0x00,0x00,0x18,0x18,0x18,0xFF,0x18,0x18,0x18,0x00,0x00,0x00,0x00,0x00},
	/* , */
	{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x18,0x30,0x00,0x00},
	/* - */
	{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	/* . */
	{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00},
	/* / */
	{0x00,0x00,0x01,0x03,0x07,0x0E,0x1C,0x38,0x70,0xE0,0xC0,0x80,0x00,0x00,0x00,0x00},
	/* 0 */
	{0x00,0x00,0x3C,0x66,0xC3,0xC3,0xDB,0xDB,0xC3,0xC3,0x66,0x3C,0x00,0x00,0x00,0x00},
	/* 1 */
	{0x00,0x00,0x18,0x38,0x58,0x18,0x18,0x18,0x18,0x18,0x18,0x7E,0x00,0x00,0x00,0x00},
	/* 2 */
	{0x00,0x00,0x3C,0x66,0xC3,0x03,0x06,0x0C,0x18,0x30,0x60,0xFF,0x00,0x00,0x00,0x00},
	/* 3 */
	{0x00,0x00,0x3C,0x66,0xC3,0x03,0x03,0x1E,0x03,0x03,0x66,0x3C,0x00,0x00,0x00,0x00},
	/* 4 */
	{0x00,0x00,0x06,0x0E,0x1E,0x36,0x66,0xC6,0xFF,0x06,0x06,0x0F,0x00,0x00,0x00,0x00},
	/* 5 */
	{0x00,0x00,0xFF,0xC0,0xC0,0xC0,0xFC,0x06,0x03,0x03,0x66,0x3C,0x00,0x00,0x00,0x00},
	/* 6 */
	{0x00,0x00,0x1C,0x30,0x60,0xC0,0xFC,0xC6,0xC3,0xC3,0x66,0x3C,0x00,0x00,0x00,0x00},
	/* 7 */
	{0x00,0x00,0xFF,0x03,0x03,0x06,0x0C,0x18,0x30,0x60,0x60,0x60,0x00,0x00,0x00,0x00},
	/* 8 */
	{0x00,0x00,0x3C,0x66,0xC3,0x66,0x3C,0x66,0xC3,0xC3,0x66,0x3C,0x00,0x00,0x00,0x00},
	/* 9 */
	{0x00,0x00,0x3C,0x66,0xC3,0xC3,0x67,0x3F,0x03,0x06,0x0C,0x38,0x00,0x00,0x00,0x00},
	/* : */
	{0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00,0x00},
	/* ; */
	{0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x18,0x18,0x30,0x00,0x00,0x00,0x00},
	/* < */
	{0x00,0x00,0x00,0x06,0x0C,0x18,0x30,0x60,0x30,0x18,0x0C,0x06,0x00,0x00,0x00,0x00},
	/* = */
	{0x00,0x00,0x00,0x00,0x00,0x7E,0x00,0x00,0x7E,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	/* > */
	{0x00,0x00,0x00,0x60,0x30,0x18,0x0C,0x06,0x0C,0x18,0x30,0x60,0x00,0x00,0x00,0x00},
	/* ? */
	{0x00,0x00,0x3C,0x66,0xC3,0xC3,0x06,0x0C,0x18,0x18,0x00,0x18,0x00,0x00,0x00,0x00},
	/* @ */
	{0x00,0x00,0x3C,0x66,0xC3,0xC3,0xCF,0xDB,0xDB,0xCF,0xC0,0x7F,0x00,0x00,0x00,0x00},
	/* A */
	{0x00,0x00,0x08,0x1C,0x36,0x63,0x63,0x63,0x7F,0x63,0x63,0x63,0x00,0x00,0x00,0x00},
	/* B */
	{0x00,0x00,0xFC,0x66,0x63,0x66,0x7C,0x66,0x63,0x63,0x66,0xFC,0x00,0x00,0x00,0x00},
	/* C */
	{0x00,0x00,0x3C,0x66,0xC3,0xC0,0xC0,0xC0,0xC0,0xC3,0x66,0x3C,0x00,0x00,0x00,0x00},
	/* D */
	{0x00,0x00,0xFC,0x66,0x63,0x63,0x63,0x63,0x63,0x63,0x66,0xFC,0x00,0x00,0x00,0x00},
	/* E */
	{0x00,0x00,0xFF,0x60,0x60,0x60,0x7C,0x60,0x60,0x60,0x60,0xFF,0x00,0x00,0x00,0x00},
	/* F */
	{0x00,0x00,0xFF,0x60,0x60,0x60,0x7C,0x60,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00},
	/* G */
	{0x00,0x00,0x3C,0x66,0xC3,0xC0,0xC0,0xCF,0xC3,0xC3,0x66,0x3D,0x00,0x00,0x00,0x00},
	/* H */
	{0x00,0x00,0xC3,0xC3,0xC3,0xC3,0xFF,0xC3,0xC3,0xC3,0xC3,0xC3,0x00,0x00,0x00,0x00},
	/* I */
	{0x00,0x00,0x7E,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x7E,0x00,0x00,0x00,0x00},
	/* J */
	{0x00,0x00,0x1F,0x0C,0x0C,0x0C,0x0C,0x0C,0xCC,0xCC,0xCC,0x78,0x00,0x00,0x00,0x00},
	/* K */
	{0x00,0x00,0xC6,0xCC,0xD8,0xF0,0xE0,0xF0,0xD8,0xCC,0xC6,0xC3,0x00,0x00,0x00,0x00},
	/* L */
	{0x00,0x00,0xF0,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0xFF,0x00,0x00,0x00,0x00},
	/* M */
	{0x00,0x00,0xC3,0xE7,0xFF,0xDB,0xDB,0xC3,0xC3,0xC3,0xC3,0xC3,0x00,0x00,0x00,0x00},
	/* N */
	{0x00,0x00,0xC3,0xE3,0xF3,0xDB,0xCF,0xC7,0xC3,0xC3,0xC3,0xC3,0x00,0x00,0x00,0x00},
	/* O */
	{0x00,0x00,0x3C,0x66,0xC3,0xC3,0xC3,0xC3,0xC3,0xC3,0x66,0x3C,0x00,0x00,0x00,0x00},
	/* P */
	{0x00,0x00,0xFC,0x66,0x63,0x63,0x66,0x7C,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00},
	/* Q */
	{0x00,0x00,0x3C,0x66,0xC3,0xC3,0xC3,0xC3,0xC3,0xDB,0x66,0x3C,0x06,0x03,0x00,0x00},
	/* R */
	{0x00,0x00,0xFC,0x66,0x63,0x63,0x66,0x7C,0x6C,0x66,0x63,0xF3,0x00,0x00,0x00,0x00},
	/* S */
	{0x00,0x00,0x3E,0x63,0x60,0x60,0x3E,0x03,0x03,0x03,0x63,0x3E,0x00,0x00,0x00,0x00},
	/* T */
	{0x00,0x00,0xFF,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
	/* U */
	{0x00,0x00,0xC3,0xC3,0xC3,0xC3,0xC3,0xC3,0xC3,0xC3,0x66,0x3C,0x00,0x00,0x00,0x00},
	/* V */
	{0x00,0x00,0xC3,0xC3,0xC3,0xC3,0xC3,0xC3,0x66,0x3C,0x18,0x08,0x00,0x00,0x00,0x00},
	/* W */
	{0x00,0x00,0xC3,0xC3,0xC3,0xC3,0xDB,0xDB,0xDB,0xFF,0x66,0x66,0x00,0x00,0x00,0x00},
	/* X */
	{0x00,0x00,0xC3,0xC3,0x66,0x3C,0x18,0x18,0x3C,0x66,0xC3,0xC3,0x00,0x00,0x00,0x00},
	/* Y */
	{0x00,0x00,0xC3,0xC3,0x66,0x3C,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
	/* Z */
	{0x00,0x00,0xFF,0x03,0x06,0x0C,0x18,0x30,0x60,0xC0,0xC0,0xFF,0x00,0x00,0x00,0x00},
	/* [ */
	{0x00,0x00,0x3C,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x3C,0x00,0x00,0x00,0x00},
	/* \ */
	{0x00,0x00,0x80,0xC0,0xE0,0x70,0x38,0x1C,0x0E,0x07,0x03,0x01,0x00,0x00,0x00,0x00},
	/* ] */
	{0x00,0x00,0x3C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x3C,0x00,0x00,0x00,0x00},
	/* ^ */
	{0x08,0x1C,0x36,0x63,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	/* _ */
	{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00},
	/* ` */
	{0x00,0x18,0x18,0x18,0x0C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	/* a */
	{0x00,0x00,0x00,0x00,0x00,0x3E,0x03,0x3F,0x63,0x63,0x67,0x3D,0x00,0x00,0x00,0x00},
	/* b */
	{0x00,0x00,0xC0,0xC0,0xC0,0xDC,0xE6,0xC3,0xC3,0xC3,0xE6,0xDC,0x00,0x00,0x00,0x00},
	/* c */
	{0x00,0x00,0x00,0x00,0x00,0x3E,0x63,0x60,0x60,0x60,0x63,0x3E,0x00,0x00,0x00,0x00},
	/* d */
	{0x00,0x00,0x03,0x03,0x03,0x3B,0x67,0xC3,0xC3,0xC3,0x67,0x3B,0x00,0x00,0x00,0x00},
	/* e */
	{0x00,0x00,0x00,0x00,0x00,0x3C,0x66,0xC3,0xFF,0xC0,0x63,0x3E,0x00,0x00,0x00,0x00},
	/* f */
	{0x00,0x00,0x0E,0x1B,0x18,0x18,0x7E,0x18,0x18,0x18,0x18,0x7E,0x00,0x00,0x00,0x00},
	/* g */
	{0x00,0x00,0x00,0x00,0x00,0x3B,0x67,0xC3,0xC3,0x67,0x3B,0x03,0x63,0x3E,0x00,0x00},
	/* h */
	{0x00,0x00,0xC0,0xC0,0xC0,0xDC,0xE6,0xC3,0xC3,0xC3,0xC3,0xC3,0x00,0x00,0x00,0x00},
	/* i */
	{0x00,0x00,0x18,0x18,0x00,0x78,0x18,0x18,0x18,0x18,0x18,0x7E,0x00,0x00,0x00,0x00},
	/* j */
	{0x00,0x00,0x0C,0x0C,0x00,0x3C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x6C,0x38,0x00,0x00},
	/* k */
	{0x00,0x00,0xC0,0xC0,0xC0,0xC6,0xCC,0xD8,0xF8,0xCC,0xC6,0xC3,0x00,0x00,0x00,0x00},
	/* l */
	{0x00,0x00,0x78,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x7E,0x00,0x00,0x00,0x00},
	/* m */
	{0x00,0x00,0x00,0x00,0x00,0xEC,0xFE,0xDB,0xDB,0xDB,0xDB,0xDB,0x00,0x00,0x00,0x00},
	/* n */
	{0x00,0x00,0x00,0x00,0x00,0xDC,0xE6,0xC3,0xC3,0xC3,0xC3,0xC3,0x00,0x00,0x00,0x00},
	/* o */
	{0x00,0x00,0x00,0x00,0x00,0x3C,0x66,0xC3,0xC3,0xC3,0x66,0x3C,0x00,0x00,0x00,0x00},
	/* p */
	{0x00,0x00,0x00,0x00,0x00,0xDC,0xE6,0xC3,0xC3,0xE6,0xDC,0xC0,0xC0,0xF0,0x00,0x00},
	/* q */
	{0x00,0x00,0x00,0x00,0x00,0x3B,0x67,0xC3,0xC3,0x67,0x3B,0x03,0x03,0x0F,0x00,0x00},
	/* r */
	{0x00,0x00,0x00,0x00,0x00,0xDC,0xE6,0xC0,0xC0,0xC0,0xC0,0xF0,0x00,0x00,0x00,0x00},
	/* s */
	{0x00,0x00,0x00,0x00,0x00,0x3E,0x63,0x60,0x3E,0x03,0x63,0x3E,0x00,0x00,0x00,0x00},
	/* t */
	{0x00,0x00,0x00,0x18,0x18,0x7E,0x18,0x18,0x18,0x18,0x1B,0x0E,0x00,0x00,0x00,0x00},
	/* u */
	{0x00,0x00,0x00,0x00,0x00,0xC3,0xC3,0xC3,0xC3,0xC3,0x67,0x3B,0x00,0x00,0x00,0x00},
	/* v */
	{0x00,0x00,0x00,0x00,0x00,0xC3,0xC3,0x66,0x66,0x3C,0x3C,0x18,0x00,0x00,0x00,0x00},
	/* w */
	{0x00,0x00,0x00,0x00,0x00,0xC3,0xC3,0xDB,0xDB,0xDB,0xFF,0x66,0x00,0x00,0x00,0x00},
	/* x */
	{0x00,0x00,0x00,0x00,0x00,0xC3,0x66,0x3C,0x18,0x3C,0x66,0xC3,0x00,0x00,0x00,0x00},
	/* y */
	{0x00,0x00,0x00,0x00,0x00,0xC3,0xC3,0x66,0x3C,0x18,0x18,0x30,0x60,0xE0,0x00,0x00},
	/* z */
	{0x00,0x00,0x00,0x00,0x00,0x7F,0x06,0x0C,0x18,0x30,0x60,0x7F,0x00,0x00,0x00,0x00},
	/* { */
	{0x00,0x00,0x0E,0x18,0x18,0x18,0x70,0x18,0x18,0x18,0x18,0x0E,0x00,0x00,0x00,0x00},
	/* | */
	{0x00,0x00,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x00,0x00,0x00},
	/* } */
	{0x00,0x00,0x70,0x18,0x18,0x18,0x0E,0x18,0x18,0x18,0x18,0x70,0x00,0x00,0x00,0x00},
	/* ~ */
	{0x00,0x00,0x3B,0x6E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
};

extern void (*screenputs)(char*, int);
extern void uartputs(char*, int);

void
fbconsoleinit(void)
{
	struct limine_framebuffer_response *fb_response;
	struct limine_framebuffer *framebuffer;
	extern uintptr saved_limine_hhdm_offset;

	uartputs("fbconsole: HHDM mappings incomplete, skipping framebuffer console\n", 68);
	return;

	uartputs("fbconsoleinit: starting\n", 24);

	if(limine_framebuffer == nil){
		uartputs("fbconsole: limine_framebuffer is nil\n", 38);
		return;
	}

	if(limine_framebuffer->response == nil){
		uartputs("fbconsole: no framebuffer response\n", 36);
		return;
	}

	fb_response = limine_framebuffer->response;
	print("fbconsole: response pointer=%#p\n", fb_response);
	if((uintptr)fb_response < 0xFFFF800000000000ULL)
		fb_response = (struct limine_framebuffer_response*)((uintptr)fb_response + saved_limine_hhdm_offset);
	print("fbconsole: response mapped=%#p\n", fb_response);
	if(fb_response->framebuffer_count == 0){
		uartputs("fbconsole: no framebuffers\n", 28);
		return;
	}

	framebuffer = fb_response->framebuffers[0];
	print("fbconsole: raw framebuffer ptr=%#p\n", framebuffer);

	/* Framebuffer address might be a physical address,  map it through HHDM */
	uintptr fbaddr = (uintptr)framebuffer->address;

	/* If address looks like a physical address (below kernel space), add HHDM offset */
	if(fbaddr < 0xFFFF800000000000ULL)
		fbaddr += saved_limine_hhdm_offset;

	fb.addr = (uchar*)fbaddr;
	fb.width = framebuffer->width;
	fb.height = framebuffer->height;
	fb.pitch = framebuffer->pitch;
	fb.bpp = framebuffer->bpp;
	fb.x = 0;
	fb.y = 0;
	fb.fg = 0xFFFFFF;  /* White */
	fb.bg = 0x000000;  /* Black */
	fb.initialized = 1;

	print("fbconsole: %llux%llu@%u bpp=%u\n", fb.width, fb.height, fb.bpp, fb.pitch);

	/* Clear screen */
	memset(fb.addr, 0, fb.pitch * fb.height);

	/* Hook into screenputs */
	screenputs = fbconsolescreenputs;
}

static void
fbputpixel(int x, int y, u32int color)
{
	u32int *pixel;

	if(!fb.initialized || x < 0 || y < 0 || x >= fb.width || y >= fb.height)
		return;

	pixel = (u32int*)(fb.addr + y * fb.pitch + x * (fb.bpp / 8));
	*pixel = color;
}

static void
fbputchar(int x, int y, int c, u32int fg, u32int bg)
{
	int row, col, bit;
	uchar *glyph;

	if(!fb.initialized)
		return;

	/* Only handle printable ASCII */
	if(c < 32 || c > 126)
		c = ' ';

	glyph = font8x16[c - 32];

	for(row = 0; row < FONT_HEIGHT; row++){
		for(col = 0; col < FONT_WIDTH; col++){
			bit = (glyph[row] >> (7 - col)) & 1;
			fbputpixel(x + col, y + row, bit ? fg : bg);
		}
	}
}

static void
fbscroll(void)
{
	int src_y, dst_y;

	if(!fb.initialized)
		return;

	/* Copy screen up by one line */
	src_y = FONT_HEIGHT;
	dst_y = 0;
	memmove(fb.addr + dst_y * fb.pitch,
		fb.addr + src_y * fb.pitch,
		fb.pitch * (fb.height - FONT_HEIGHT));

	/* Clear bottom line */
	memset(fb.addr + (fb.height - FONT_HEIGHT) * fb.pitch, 0, fb.pitch * FONT_HEIGHT);
}

void
fbconsoleputc(int c)
{
	int max_cols, max_rows;

	if(!fb.initialized)
		return;

	max_cols = fb.width / FONT_WIDTH;
	max_rows = fb.height / FONT_HEIGHT;

	switch(c){
	case '\n':
		fb.x = 0;
		fb.y++;
		break;
	case '\r':
		fb.x = 0;
		break;
	case '\t':
		fb.x = (fb.x + 8) & ~7;
		break;
	case '\b':
		if(fb.x > 0)
			fb.x--;
		break;
	default:
		if(c >= 32 && c < 127){
			fbputchar(fb.x * FONT_WIDTH, fb.y * FONT_HEIGHT, c, fb.fg, fb.bg);
			fb.x++;
		}
		break;
	}

	/* Wrap to next line */
	if(fb.x >= max_cols){
		fb.x = 0;
		fb.y++;
	}

	/* Scroll if needed */
	if(fb.y >= max_rows){
		fbscroll();
		fb.y = max_rows - 1;
	}
}

void
fbconsolescreenputs(char *s, int n)
{
	int i;

	if(!fb.initialized)
		return;

	for(i = 0; i < n; i++)
		fbconsoleputc(s[i]);
}
